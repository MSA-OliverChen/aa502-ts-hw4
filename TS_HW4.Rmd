---
title: "Time Series Homework 4"
author: "Team 6 - Oliver Chen, Hannah Enck, Jamil Gracia, Ava Klissouras"
date: "2025-10-26"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Setup

Load libraries.

```{r}
library(tsibble)
library(tidyverse)
library(ggplot2)
library(forecast)
library(fable)
library(fpp3)
library(tseries)
```


Read in data.

```{r}
data_path = "https://raw.githubusercontent.com/sjsimmo2/TimeSeries/refs/heads/master/energy_F2025.csv"
energy <- readr::read_csv(data_path, show_col_types=FALSE)
```

Roll up data.

```{r}
energy_daily <- energy %>%
  mutate(new_datetime = mdy_hm(datetime_beginning_ept),
         date = as_date(new_datetime)) %>%
  group_by(date) %>%
  summarise(daily_total = sum(mw))
```


Train test split.

```{r}
#Train: data from August 2018 - August 2023
train <- energy_daily %>%
  filter(date >= as.Date("2018-08-01") & date < as.Date("2023-08-01"))

train.ts = train %>%
  as_tsibble(index = date)

#Validation: data from September 2023 - August 2024
validation <- energy_daily %>%
  filter(date >= as.Date("2023-08-01") & date < as.Date("2024-08-01"))

validation.ts = validation %>%
  as_tsibble(index = date)

#Test: data from September 2024 - August 2025
test <- energy_daily %>%
  filter(date >= as.Date("2024-08-01") & date < as.Date("2025-08-01"))

test.ts = test %>%
  as_tsibble(index = date)
```


Check for missing values.

```{r}
has_gaps(train.ts)
has_gaps(validation.ts)
has_gaps(test.ts)

#All return FALSE- good. No implicit missingness
```

# Analysis

## Exponential Smoothing Model (ESM)

### Performing STL decomposition on training data to assess trend/seasonality
```{r}
dcmp = train.ts %>% model (stl = STL (daily_total))
components(dcmp) %>% autoplot() + theme_classic()
```

```{r}
train.ts %>% 
  features(daily_total, feat_stl, .period = "year")

train.ts %>% 
  features(daily_total, feat_stl, .period = 7)

#Yearly seasonal strength is much stronger than weekly, so we will just stick with year

```


### Fitting models
```{r}
esm_fit <- train.ts |>
  model(
    #Just weekly seasonality since ESM does not support periods longer than 24 (i.e. year would be 365 since we have daily data)
    'HWAddWeek' = ETS(daily_total ~ error("A") + trend("A") + season("A", period="week")),
    'HWMultWeek' = ETS(daily_total ~ error("M") + trend("A") + season("M", period="week")),
    'NoTrendWeek' = ETS(daily_total ~ error("A") + trend("N") + season("A", period="week"))
  )
```

```{r}
esm_fc <- esm_fit %>%
  fabletools::forecast(h = nrow(validation))
fabletools::accuracy(esm_fc, validation.ts)
```

```{r}
#Search for best one
esm_auto <- train.ts %>%
  model(ETS(daily_total))

report(esm_auto) #MNA

auto_fc <- esm_auto %>%
  fabletools::forecast(h = nrow(validation)-1)
fabletools::accuracy(auto_fc, validation.ts)

#Worse than the ones we did manually

```

### Actual vs. Forecasted Plot

```{r}
#Best model of all the ones above was Holt-Winters additive

#Get forecast
HW_add <- train.ts |>
  model(
    ETS(daily_total ~ error("A") + trend("A") + season("A", period="week"))
  )
ESM_fc <- HW_add %>%
  fabletools::forecast(h = nrow(validation)-1)

ggplot() + geom_line(data = ESM_fc, aes(x=date, y=.mean, color = "Forecast")) + 
  geom_line(data = validation.ts, aes(x=date, y=daily_total, color = "Actual"))+
  labs(x="Month", y="Megawatts", title="Total Daily Energy Consumption", color = "Series") + 
  scale_color_manual (values=c("Actual"="black","Forecast" = "orange" ))
```

## Seasonal ARIMA

Recall that yearly seasonality was the strongest.

```{r}
train.ts %>%
  features(daily_total, feat_stl, .period = 'week')

train.ts %>%
  features(daily_total, feat_stl, .period = 'year')
```

### Approaches

#### Stochastic

#### Deterministic

##### Dummy Variables

```{r}
# weekday only realistic one to do
sd_arima <- train.ts %>%
  mutate(day_of_week = wday(date)) %>%
  model(ARIMA(daily_total ~ factor(day_of_week) + PDQ(D = 0)))
report(sd_arima)
```

#### Fourier

Let's try Fourier terms up to $k=10$. Note here that we use $P=Q=D=d=0$ because we want to try to capture non-stationarity through the seasonal components only.

```{r}
fourier_year_arima <- train.ts %>%
  model(
    `K = 1` = ARIMA(daily_total ~ fourier(K=1, period = 'year') + PDQ(0, 0, 0) + pdq(d = 0)),
    `K = 2` = ARIMA(daily_total ~ fourier(K=2, period = 'year') + PDQ(0, 0, 0) + pdq(d = 0)),
    `K = 3` = ARIMA(daily_total ~ fourier(K=3, period = 'year') + PDQ(0, 0, 0) + pdq(d = 0)),
    `K = 4` = ARIMA(daily_total ~ fourier(K=4, period = 'year') + PDQ(0, 0, 0) + pdq(d = 0)),
    `K = 5` = ARIMA(daily_total ~ fourier(K=5, period = 'year') + PDQ(0, 0, 0) + pdq(d = 0)),
    `K = 6` = ARIMA(daily_total ~ fourier(K=6, period = 'year') + PDQ(0, 0, 0) + pdq(d = 0)),
    `K = 7` = ARIMA(daily_total ~ fourier(K=7, period = 'year') + PDQ(0, 0, 0) + pdq(d = 0)),
    `K = 8` = ARIMA(daily_total ~ fourier(K=8, period = 'year') + PDQ(0, 0, 0) + pdq(d = 0)),
    `K = 9` = ARIMA(daily_total ~ fourier(K=9, period = 'year') + PDQ(0, 0, 0) + pdq(d = 0)),
    `K = 10` = ARIMA(daily_total ~ fourier(K=10, period = 'year') + PDQ(0, 0, 0) + pdq(d = 0))
  )
glance(fourier_year_arima)
```

Seems like the best harmonic frequency for yearly seasonality is $K=7$ based on AICc. Now, let's try to capture the weekly seasonality.

<!-- Should I instead be doing a grid search? -->

```{r}
fourier_week_arima <- train.ts %>%
  model(
    `K = 1` = ARIMA(daily_total ~ fourier(K=1, period = 'week') + 
                                  fourier(K=7, period = 'year') + 
                                  PDQ(0, 0, 0) + pdq(d = 0)),
    `K = 2` = ARIMA(daily_total ~ fourier(K=2, period = 'week') + 
                                  fourier(K=7, period = 'year') + 
                                  PDQ(0, 0, 0) + pdq(d = 0)),
    `K = 3` = ARIMA(daily_total ~ fourier(K=3, period = 'week') + 
                                  fourier(K=7, period = 'year') + 
                                  PDQ(0, 0, 0) + pdq(d = 0)),
  )
glance(fourier_week_arima)
```

```{r}
fourier_final_arima = fourier_week_arima %>%
  select(`K = 3`)

report(fourier_final_arima)
```

Let's confirm that we have white noise.

```{r}
# test up to 2 * S, as recommended by Hyndman
lag = 2 * 365.25
# p + q = 1 + 4 = 5
dof = 5
augment(fourier_final_arima) %>%
  features(.innov, ljung_box, lag=lag, dof=dof)

fourier_final_arima %>%
  ggtime::gg_tsresiduals(lag=lag)
```

### Forecast on Validation

```{r}
arima_fc <- fourier_final_arima %>%
  fabletools::forecast(h = nrow(validation)-1)

ggplot() + geom_line(data = arima_fc , aes(x=date, y=.mean, color = "Forecast")) + 
  geom_line(data = validation.ts, aes(x=date, y=daily_total, color = "Actual"))+
  labs(x="Month", y="Megawatts", title="Total Daily Energy Consumption", color = "Series") + 
  scale_color_manual (values=c("Actual"="black","Forecast" = "orange" ))
```


### Model Accuracy

```{r}
# get SD for MAE report
energy_daily %>% pull(daily_total) %>% sd()

fabletools::accuracy(arima_fc, validation.ts) %>%
  select(c(MAE, MAPE))
```

Accuracy measures of the model are as follows:
* MAE: 7541.57 (SD = 15300.61)
* MAPE: 7.23%
